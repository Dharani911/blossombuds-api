<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <changeSet id="0019-01-customers-id-identity" author="dharani">

        <preConditions onFail="MARK_RAN" onError="HALT">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.columns
                WHERE  table_name   = 'customers'
                AND column_name  = 'id'
                AND is_identity  = 'YES'
            </sqlCheck>
        </preConditions>

        <sql>
            ALTER TABLE customers
            ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
        </sql>

        <!--  rollback  -->
        <rollback>
            ALTER TABLE customers
            ALTER COLUMN id DROP IDENTITY IF EXISTS;
        </rollback>
    </changeSet>

    <!-- Only proceed if settings table exists -->


    <!-- 1) Add id column if missing -->
    <changeSet id="0019-02-settings-add-id-column" author="dharani">
        <preConditions onFail="MARK_RAN" onError="HALT">
            <not>
                <columnExists tableName="settings" columnName="id"/>
            </not>
        </preConditions>

        <addColumn tableName="settings">
            <column name="id" type="BIGINT"/>
        </addColumn>

        <rollback>
            <dropColumn tableName="settings" columnName="id"/>
        </rollback>
    </changeSet>

    <changeSet id="0019-03a-settings-seq-default-backfill" author="dharani" dbms="postgresql">
        <preConditions onFail="MARK_RAN" onError="HALT">
            <!-- Skip if id already identity or has nextval default -->
            <sqlCheck expectedResult="0"><![CDATA[
        SELECT COUNT(*)
        FROM information_schema.columns
        WHERE table_name = 'settings'
          AND table_schema = current_schema()
          AND column_name = 'id'
          AND (is_identity = 'YES' OR column_default LIKE 'nextval(%')
      ]]></sqlCheck>
        </preConditions>

        <!-- Create sequence if missing -->
        <sql><![CDATA[
      CREATE SEQUENCE IF NOT EXISTS settings_id_seq START WITH 1 INCREMENT BY 1;
    ]]></sql>

        <!-- Set default to sequence -->
        <sql><![CDATA[
      ALTER TABLE settings
        ALTER COLUMN id SET DEFAULT nextval('settings_id_seq');
    ]]></sql>

        <!-- Backfill null ids -->
        <sql><![CDATA[
      UPDATE settings
         SET id = nextval('settings_id_seq')
       WHERE id IS NULL;
    ]]></sql>

        <!-- Enforce not null + primary key -->
        <addNotNullConstraint tableName="settings" columnName="id" columnDataType="BIGINT"/>
        <addPrimaryKey tableName="settings" columnNames="id" constraintName="pk_settings_id"/>

        <rollback>
            <!-- Optional/unsafe in shared envs; keep conservative -->
            <dropPrimaryKey tableName="settings" constraintName="pk_settings_id"/>
            <sql><![CDATA[
        ALTER TABLE settings ALTER COLUMN id DROP DEFAULT;
      ]]></sql>
            <!-- Do NOT drop the sequence automatically unless youâ€™re sure -->
            <!-- <sql><![CDATA[ DROP SEQUENCE IF EXISTS settings_id_seq; ]]></sql> -->
        </rollback>
    </changeSet>

    <!-- B) Partial unique index: one active row per key -->
    <changeSet id="0019-03b-settings-unique-active" author="dharani" dbms="postgresql">
        <preConditions onFail="MARK_RAN" onError="HALT">
            <not>
                <indexExists indexName="uq_settings_key_active"/>
            </not>
        </preConditions>

        <sql><![CDATA[
      CREATE UNIQUE INDEX uq_settings_key_active
        ON settings ("key")
        WHERE active IS TRUE;
    ]]></sql>

        <rollback>
            <sql><![CDATA[
        DROP INDEX IF EXISTS uq_settings_key_active;
      ]]></sql>
        </rollback>
    </changeSet>

</databaseChangeLog>