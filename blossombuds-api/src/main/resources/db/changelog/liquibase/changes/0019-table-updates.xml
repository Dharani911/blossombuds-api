<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <changeSet id="0019-01-customers-id-identity" author="dharani">

        <preConditions onFail="MARK_RAN" onError="HALT">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*)
                FROM information_schema.columns
                WHERE  table_name   = 'customers'
                AND column_name  = 'id'
                AND is_identity  = 'YES'
            </sqlCheck>
        </preConditions>

        <sql>
            ALTER TABLE customers
            ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
        </sql>

        <!--  rollback  -->
        <rollback>
            ALTER TABLE customers
            ALTER COLUMN id DROP IDENTITY IF EXISTS;
        </rollback>
    </changeSet>

    <!-- Only proceed if settings table exists -->


    <!-- 1) Add id column if missing -->
    <changeSet id="0019-02-settings-add-id-column" author="dharani">
        <preConditions onFail="MARK_RAN" onError="HALT">
            <not>
                <columnExists tableName="settings" columnName="id"/>
            </not>
        </preConditions>

        <addColumn tableName="settings">
            <column name="id" type="BIGINT"/>
        </addColumn>

        <rollback>
            <dropColumn tableName="settings" columnName="id"/>
        </rollback>
    </changeSet>

    <changeSet id="0019-03a-settings-seq-default-backfill" author="dharani" dbms="postgresql">
        <preConditions onFail="MARK_RAN" onError="HALT">
            <!-- Skip if id already identity or has nextval default -->
            <sqlCheck expectedResult="0"><![CDATA[
        SELECT COUNT(*)
        FROM information_schema.columns
        WHERE table_name = 'settings'
          AND table_schema = current_schema()
          AND column_name = 'id'
          AND (is_identity = 'YES' OR column_default LIKE 'nextval(%')
      ]]></sqlCheck>
        </preConditions>

        <!-- Create sequence if missing -->
        <sql><![CDATA[
      CREATE SEQUENCE IF NOT EXISTS settings_id_seq START WITH 1 INCREMENT BY 1;
    ]]></sql>

        <!-- Set default to sequence -->
        <sql><![CDATA[
      ALTER TABLE settings
        ALTER COLUMN id SET DEFAULT nextval('settings_id_seq');
    ]]></sql>

        <!-- Backfill null ids -->
        <sql><![CDATA[
      UPDATE settings
         SET id = nextval('settings_id_seq')
       WHERE id IS NULL;
    ]]></sql>

        <!-- Enforce not null + primary key -->
        <addNotNullConstraint tableName="settings" columnName="id" columnDataType="BIGINT"/>
        <addPrimaryKey tableName="settings" columnNames="id" constraintName="pk_settings_id"/>

        <rollback>
            <!-- Optional/unsafe in shared envs; keep conservative -->
            <dropPrimaryKey tableName="settings" constraintName="pk_settings_id"/>
            <sql><![CDATA[
        ALTER TABLE settings ALTER COLUMN id DROP DEFAULT;
      ]]></sql>
            <!-- Do NOT drop the sequence automatically unless youâ€™re sure -->
            <!-- <sql><![CDATA[ DROP SEQUENCE IF EXISTS settings_id_seq; ]]></sql> -->
        </rollback>
    </changeSet>

    <!-- B) Partial unique index: one active row per key -->
    <changeSet id="0019-03b-settings-unique-active" author="dharani" dbms="postgresql">
        <preConditions onFail="MARK_RAN" onError="HALT">
            <not>
                <indexExists indexName="uq_settings_key_active"/>
            </not>
        </preConditions>

        <sql><![CDATA[
      CREATE UNIQUE INDEX uq_settings_key_active
        ON settings ("key")
        WHERE active IS TRUE;
    ]]></sql>

        <rollback>
            <sql><![CDATA[
        DROP INDEX IF EXISTS uq_settings_key_active;
      ]]></sql>
        </rollback>
    </changeSet>
    <changeSet id="0019-04-add-min-items-to-coupons" author="dharani">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="coupons" columnName="min_items"/>
            </not>
        </preConditions>

        <!-- 1) Add column (nullable) -->
        <addColumn tableName="coupons">
            <column name="min_items" type="integer"
                    remarks="Minimum number of items required for coupon to apply (null = no rule)"/>
        </addColumn>

        <!-- 2) Add non-negative check constraint via SQL for max compatibility -->
        <sql>
            ALTER TABLE coupons
            ADD CONSTRAINT chk_coupons_min_items_nonneg
            CHECK (min_items IS NULL OR min_items &gt;= 0);
        </sql>

        <rollback>
            <!-- Drop constraint then column -->
            <sql>
                ALTER TABLE coupons
                DROP CONSTRAINT IF EXISTS chk_coupons_min_items_nonneg;
            </sql>
            <dropColumn tableName="coupons" columnName="min_items"/>
        </rollback>
    </changeSet>
    <changeSet id="0019-05-products-feature-visibility" author="dharani">
        <comment>Add featured flags and visibility to products</comment>

        <addColumn tableName="products">
            <column name="featured" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="featured_rank" type="integer" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="visible" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <!-- Helpful indexes for common storefront queries -->
        <createIndex tableName="products" indexName="idx_products_featured_rank">
            <column name="featured"/>
            <column name="featured_rank"/>
            <column name="id"/>
        </createIndex>

        <createIndex tableName="products" indexName="idx_products_visible">
            <column name="visible"/>
        </createIndex>

        <rollback>
            <dropIndex tableName="products" indexName="idx_products_visible"/>
            <dropIndex tableName="products" indexName="idx_products_featured_rank"/>
            <dropColumn tableName="products" columnName="visible"/>
            <dropColumn tableName="products" columnName="featured_rank"/>
            <dropColumn tableName="products" columnName="featured"/>
        </rollback>
    </changeSet>

    <!-- ===================== 2) product_options: visible ===================== -->
    <changeSet id="0019-06-product-options-visibility" author="dharani">
        <comment>Add visibility flag to product_options</comment>

        <addColumn tableName="product_options">
            <column name="visible" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <createIndex tableName="product_options" indexName="idx_product_options_visible">
            <column name="visible"/>
        </createIndex>

        <rollback>
            <dropIndex tableName="product_options" indexName="idx_product_options_visible"/>
            <dropColumn tableName="product_options" columnName="visible"/>
        </rollback>
    </changeSet>

    <!-- ===================== 3) product_option_values: visible ===================== -->
    <changeSet id="0019-07-product-option-values-visibility" author="dharani">
        <comment>Add visibility flag to product_option_values</comment>

        <addColumn tableName="product_option_values">
            <column name="visible" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <createIndex tableName="product_option_values" indexName="idx_pov_visible">
            <column name="visible"/>
        </createIndex>

        <rollback>
            <dropIndex tableName="product_option_values" indexName="idx_pov_visible"/>
            <dropColumn tableName="product_option_values" columnName="visible"/>
        </rollback>
    </changeSet>
    <changeSet id="0019-08-add-external-reference-to-orders" author="dharani">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="orders" columnName="external_reference"/>
            </not>
        </preConditions>

        <addColumn tableName="orders">
            <column name="external_reference" type="varchar(128)">
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- Handy for quick lookups by payment ref -->
        <createIndex indexName="idx_orders_external_reference" tableName="orders">
            <column name="external_reference"/>
        </createIndex>

        <rollback>
            <dropIndex indexName="idx_orders_external_reference" tableName="orders"/>
            <dropColumn tableName="orders" columnName="external_reference"/>
        </rollback>
    </changeSet>
    <changeSet id="0019-09-ship-country-alter-inplace" author="dharani">


        <!-- 1) Drop the default 'IN' -->
        <dropDefaultValue

                tableName="orders"
                columnName="ship_country"/>

        <!-- 2) Widen type to VARCHAR(100) -->
        <modifyDataType

                tableName="orders"
                columnName="ship_country"
                newDataType="VARCHAR(100)"/>

        <rollback>
            <!-- Rollback: narrow back to CHAR(2) and restore default 'IN' -->
            <modifyDataType

                    tableName="orders"
                    columnName="ship_country"
                    newDataType="CHAR(2)"/>
            <addDefaultValue

                    tableName="orders"
                    columnName="ship_country"
                    defaultValue="IN"/>
        </rollback>
    </changeSet>
    <changeSet id="0019-10-add-concern-column-product-reviews" author="dharani">
        <addColumn tableName="product_reviews">
            <column name="concern" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <!-- Optional: index for admin filters -->
        <createIndex tableName="product_reviews" indexName="idx_product_reviews_status_concern">
            <column name="status"/>
            <column name="concern"/>
        </createIndex>

        <!-- If you need to backfill existing approved rows to concern=true, uncomment:
        <update tableName="product_reviews">
            <column name="concern" valueBoolean="true"/>
            <where>status = 'APPROVED'</where>
        </update>
        -->
    </changeSet>
    <changeSet id="0019-11-add-description-column-categories" author="dharani">
        <addColumn tableName="categories">
            <column name="description" type="text" >
                <constraints nullable="true"/>
            </column>
        </addColumn>


    </changeSet>



</databaseChangeLog>